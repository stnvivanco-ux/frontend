name: Build-and-Deploy-Frontend

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: vars
        run: echo "TAG=v2" >> $GITHUB_ENV
        # üëÜ Usa aqu√≠ la versi√≥n que t√∫ definas (por ejemplo "v2", "v3"...)

      # üîπ 1Ô∏è‚É£ Login a Docker Hub
      - name: Login to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

      # üîπ 2Ô∏è‚É£ Build y push de la imagen Docker
      - name: Build and push Docker image
        run: |
          docker build -t savivancofi/frontend:${{ env.TAG }} .
          docker push savivancofi/frontend:${{ env.TAG }}

      # üîπ 3Ô∏è‚É£ Instalar oc CLI
      - name: Install OC CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz -o oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/oc
          oc version

      # üîπ 4Ô∏è‚É£ Instalar Helm
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      # üîπ 5Ô∏è‚É£ Login a OpenShift
      - name: Log in to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true
          oc project ${{ secrets.OPENSHIFT_NAMESPACE }}

      # üîπ 6Ô∏è‚É£ Desplegar con Helm (usando tu values.yml del repo)
      - name: Deploy frontend with Helm
        run: |
          helm upgrade --install frontend \
            oci://registry-1.docker.io/savivancofi/mi-chart \
            --version 0.1.0 \
            --namespace ${{ secrets.OPENSHIFT_NAMESPACE }} \
            --values helm/values.yml
